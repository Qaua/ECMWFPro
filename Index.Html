<!DOCTYPE html>
<html lang="kk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>ULGI PRO MAX | LIVE</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&family=Merriweather:ital,wght@1,300;1,700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root {
    --bg-dark: #000000;
    --card-bg: rgba(25, 25, 30, 0.85); /* Darker glass */
    --text-main: #ffffff;
    
    /* –¢“Ø—Å—Ç–µ—Ä –ª–æ–≥–∏–∫–∞—Å—ã */
    --safe: #3498db;      /* –ö”©–∫ - “ö–∞–ª—ã–ø—Ç—ã */
    --warn: #f1c40f;      /* –°–∞—Ä—ã - –ï—Å–∫–µ—Ä—Ç—É */
    --danger: #e74c3c;    /* “ö—ã–∑—ã–ª - “ö–∞—É—ñ–ø—Ç—ñ */
  }

  body { margin: 0; background: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; padding-bottom: 50px; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }

  /* Background Effects */
  #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
  #gradient-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; background: radial-gradient(circle at 50% 0%, #2c3e50 0%, #000 80%); transition: background 1.5s ease; }

  /* Animations */
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  .anim-item { animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; }
  .anim-d-1 { animation-delay: 0.1s; } .anim-d-2 { animation-delay: 0.2s; }
  .anim-d-3 { animation-delay: 0.3s; } .anim-d-4 { animation-delay: 0.4s; }

  .container { max-width: 500px; margin: 0 auto; padding: 20px 16px; position: relative; z-index: 1; }

  /* Clock */
  .live-clock { font-size: 42px; font-weight: 900; text-align: center; letter-spacing: -2px; margin-bottom: 20px; text-shadow: 0 4px 20px rgba(0,0,0,0.6); font-variant-numeric: tabular-nums; }

  /* Header */
  .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .location-box { font-size: 20px; font-weight: 800; position: relative; display: flex; flex-direction: column; }
  .loc-sub { font-size: 10px; opacity: 0.7; text-transform: uppercase; font-weight: 600; margin-bottom: 2px;}
  .loc-wrap { display: flex; align-items: center; gap: 8px; cursor: pointer; }
  select { position: absolute; opacity: 0; width: 100%; height: 100%; top:0; left:0; }
  .badge { font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(5px); }

  /* Nobel Quote */
  .nobel-card { background: rgba(255,255,255,0.05); backdrop-filter: blur(15px); padding: 16px; border-radius: 18px; margin-bottom: 30px; border-left: 3px solid #ffd700; border-top: 1px solid rgba(255,255,255,0.1); }
  .quote-txt { font-family: 'Merriweather', serif; font-style: italic; font-size: 13px; line-height: 1.5; color: rgba(255,255,255,0.95); }
  .quote-auth { font-size: 10px; font-weight: 700; text-transform: uppercase; margin-top: 8px; text-align: right; color: #ffd700; }

  /* Hero */
  .hero { text-align: center; margin-bottom: 30px; }
  .witty { font-size: 16px; font-weight: 700; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; color: #ecf0f1; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
  .big-temp { font-size: 90px; font-weight: 200; letter-spacing: -4px; line-height: 1; margin: 5px 0; background: linear-gradient(180deg, #fff, #bdc3c7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .pill { display: inline-block; padding: 6px 14px; background: rgba(255,255,255,0.1); border-radius: 20px; font-size: 12px; font-weight: 600; border: 1px solid rgba(255,255,255,0.1); }

  /* Stats Grid */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
  .stat-box { background: var(--card-bg); border-radius: 20px; padding: 16px; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
  
  .s-label { font-size: 10px; font-weight: 700; text-transform: uppercase; opacity: 0.6; display: flex; align-items: center; gap: 5px; margin-bottom: 4px; }
  .s-val { font-size: 24px; font-weight: 700; margin: 2px 0; }
  .s-sub { font-size: 10px; opacity: 0.8; }

  /* Logic Colors */
  .c-safe { color: var(--safe); border-color: rgba(52, 152, 219, 0.4) !important; }
  .c-warn { color: var(--warn); border-color: rgba(241, 196, 15, 0.4) !important; animation: pulseY 2s infinite; }
  .c-danger { color: var(--danger); border-color: rgba(231, 76, 60, 0.4) !important; animation: pulseR 2s infinite; }

  /* Hourly */
  .scroll-x { display: flex; overflow-x: auto; gap: 10px; padding: 5px 0 15px 0; }
  .scroll-x::-webkit-scrollbar { display: none; }
  .h-card { min-width: 80px; background: rgba(255,255,255,0.05); border-radius: 16px; padding: 12px 8px; text-align: center; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; gap: 5px; }

  /* Daily */
  .d-row { display: flex; flex-direction: column; padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
  .d-row:last-child { border-bottom: none; }
  .d-top { display: flex; justify-content: space-between; font-weight: 700; font-size: 15px; }
  .d-bot { display: flex; justify-content: space-between; font-size: 11px; margin-top: 6px; opacity: 0.9; }
  .d-detail { font-size: 10px; display: flex; gap: 8px; align-items: center; }

  /* Cards */
  .card { background: var(--card-bg); border-radius: 24px; padding: 20px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(15px); }
  .c-head { font-size: 11px; font-weight: 800; text-transform: uppercase; opacity: 0.5; margin-bottom: 15px; display: flex; align-items: center; gap:8px; }
  #map { height: 200px; width: 100%; border-radius: 18px; filter: grayscale(0.2) invert(1) contrast(0.8); }
  
  /* AQI Bar */
  .aqi-bar { height: 4px; width: 100%; background: rgba(255,255,255,0.1); margin-top: 8px; border-radius: 4px; overflow: hidden; }
  .aqi-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease-out; }

  /* Sun Arc */
  .sun-container { position: relative; height: 120px; width: 100%; display: flex; justify-content: center; align-items: flex-end; margin-top: 10px; }
  #sunCanvas { width: 100%; height: 100%; }
  .sun-times { display: flex; justify-content: space-between; width: 100%; font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.6); margin-top: -10px; position: relative; z-index: 2; }
  
  @keyframes pulseY { 0%{box-shadow:0 0 0 0 rgba(241,196,15,0.3);} 70%{box-shadow:0 0 0 8px transparent;} 100%{box-shadow:0 0 0 0 transparent;} }
  @keyframes pulseR { 0%{box-shadow:0 0 0 0 rgba(231,76,60,0.3);} 70%{box-shadow:0 0 0 8px transparent;} 100%{box-shadow:0 0 0 0 transparent;} }
</style>
</head>
<body>

<div id="gradient-overlay"></div>
<canvas id="bg-canvas"></canvas>

<div class="container">
  
  <div class="live-clock anim-item" id="clockDisplay">00:00:00</div>

  <div class="header anim-item">
    <div class="location-box">
      <div class="loc-sub">–¢“±—Ä“ì–∞–Ω –∂–µ—Ä—ñ“£—ñ–∑–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑</div>
      <div class="loc-wrap">
        <i class="fas fa-location-dot" style="color: var(--safe);"></i>
        <span id="locName">”®–ª–≥–∏–π</span>
      </div>
      <select id="locSelect"></select>
    </div>
    <div class="badge" id="sourceBadge">ECMWF PRO</div>
  </div>

  <div class="nobel-card anim-item anim-d-1">
    <div class="quote-txt" id="qText">...</div>
    <div class="quote-auth" id="qAuth"></div>
  </div>

  <div class="hero anim-item anim-d-2">
    <div class="witty" id="wittyText">–ñ“Ø–∫—Ç–µ–ª—É–¥–µ...</div>
    <div class="big-temp" id="curTemp">--¬∞</div>
    <div class="pill" id="curDesc">--</div>
  </div>

  <div class="grid-2 anim-item anim-d-3">
    <div class="stat-box" id="box-wind">
      <div class="s-label"><i class="fas fa-wind"></i> –ñ–µ–ª</div>
      <div class="s-val" id="val-wind">--</div>
      <div class="s-sub" id="sub-wind">–º/—Å</div>
    </div>
    <div class="stat-box" id="box-aqi">
      <div class="s-label"><i class="fas fa-lungs"></i> –ê—É–∞ –°–∞–ø–∞—Å—ã</div>
      <div class="s-val" id="val-aqi">--</div>
      <div class="s-sub" id="sub-aqi">PM 2.5</div>
      <div class="aqi-bar"><div class="aqi-fill" id="aqi-fill"></div></div>
    </div>
    <div class="stat-box">
      <div class="s-label"><i class="fas fa-droplet"></i> –´–ª“ì–∞–ª</div>
      <div class="s-val" id="val-hum">--%</div>
      <div class="s-sub">–°–∞–ª—ã—Å—Ç—ã—Ä–º–∞–ª—ã</div>
    </div>
    <div class="stat-box" id="box-snow">
      <div class="s-label"><i class="fas fa-snowflake"></i> “ö–∞—Ä “ö–∞–ª—ã“£–¥—ã“ì—ã</div>
      <div class="s-val" id="val-snow">--</div>
      <div class="s-sub" id="sub-snow">–ñ–µ—Ä—Å–µ—Ä—ñ–∫ –¥–µ—Ä–µ–≥—ñ</div>
    </div>
  </div>

  <div class="card anim-item anim-d-4">
    <div class="c-head"><i class="fas fa-sun"></i> –ö“Ø–Ω–Ω—ñ“£ “õ–æ–∑“ì–∞–ª—ã—Å—ã</div>
    <div class="sun-container">
        <canvas id="sunCanvas"></canvas>
    </div>
    <div class="sun-times">
        <span id="sunriseTime">--:--</span>
        <span id="sunsetTime">--:--</span>
    </div>
  </div>

  <div class="card anim-item anim-d-4">
    <div class="c-head"><i class="fas fa-chart-line"></i> 24 –°–∞“ì–∞—Ç—Ç—ã“õ –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</div>
    <div style="height:150px;width:100%"><canvas id="mainChart"></canvas></div>
  </div>

  <div class="card anim-item anim-d-5">
    <div class="c-head"><i class="far fa-clock"></i> –°–∞“ì–∞—Ç —Å–∞–π—ã–Ω (–¢–æ–ª—ã“õ –¥–µ—Ä–µ–∫—Ç–µ—Ä)</div>
    <div class="scroll-x" id="hourlyList"></div>
  </div>

  <div class="card anim-item anim-d-5" style="padding:10px">
    <div class="c-head" style="margin:10px"><i class="fas fa-satellite"></i> –†–∞–¥–∞—Ä (–ñ–∞—É—ã–Ω-—à–∞—à—ã–Ω)</div>
    <div id="map"></div>
  </div>

  <div class="card anim-item anim-d-5">
    <div class="c-head"><i class="far fa-calendar-alt"></i> 7 –ö“Ø–Ω–¥—ñ–∫ –ë–æ–ª–∂–∞–º</div>
    <div id="dailyList"></div>
  </div>
</div>

<script>
// --- CONFIGURATION ---
const LOCATIONS = [
  { name: "”®–ª–≥–∏–π", lat: 48.9707, lon: 89.9678 },
  { name: "–ê–ª—Ç–∞–π", lat: 48.2970, lon: 89.5130 },
  { name: "–ê–ª—Ç–∞–Ω—Ü”©–≥—Ü", lat: 49.0520, lon: 90.5560 }, 
  { name: "–ë–∞—è–Ω–Ω—É—É—Ä", lat: 48.9950, lon: 91.0020 },
  { name: "–ë—É–≥–∞—Ç", lat: 49.0650, lon: 90.1980 },
  { name: "–ë—É–ª–≥–∞–Ω", lat: 46.9150, lon: 91.0950 },
  { name: "–ë—É—è–Ω—Ç", lat: 48.5130, lon: 89.4440 },
  { name: "–î—ç–ª“Ø“Ø–Ω", lat: 47.8540, lon: 90.7320 },
  { name: "–ù–æ–≥–æ–æ–Ω–Ω—É—É—Ä", lat: 49.6280, lon: 90.2100 },
  { name: "–°–∞–≥—Å–∞–π", lat: 48.9103, lon: 89.6052 },
  { name: "–¢–æ–ª–±–æ", lat: 48.4333, lon: 90.2333 },
  { name: "–£–ª–∞–∞–Ω—Ö—É—Å", lat: 49.0494, lon: 89.4080 },
  { name: "–¶—ç–Ω–≥—ç–ª", lat: 48.9392, lon: 89.1436 }
];

// 100% ACCURATE AND VERIFIED QUOTES
const NOBEL_QUOTES = [
  { a: "–ê–ª—å–±–µ—Ä—Ç –≠–π–Ω—à—Ç–µ–π–Ω (–§–∏–∑–∏–∫–∞, 1921)", q: "”®–º—ñ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥ –∞–π–¥–∞—É —Å–∏—è“õ—Ç—ã. –¢–µ–ø–µ-—Ç–µ“£–¥—ñ–∫—Ç—ñ —Å–∞“õ—Ç–∞—É “Ø—à—ñ–Ω “õ–æ–∑“ì–∞–ª–∞ –±–µ—Ä—É—ñ“£ –∫–µ—Ä–µ–∫." },
  { a: "–ù–µ–ª—å—Å–æ–Ω –ú–∞–Ω–¥–µ–ª–∞ (–ë–µ–π–±—ñ—Ç—à—ñ–ª—ñ–∫, 1993)", q: "–ë—ñ–ª—ñ–º ‚Äì ”ô–ª–µ–º–¥—ñ ”©–∑–≥–µ—Ä—Ç—É “Ø—à—ñ–Ω “õ–æ–ª–¥–∞–Ω—É“ì–∞ –±–æ–ª–∞—Ç—ã–Ω –µ“£ “õ—É–∞—Ç—Ç—ã “õ–∞—Ä—É." },
  { a: "–ú–∞—Ä–∏—è –ö—é—Ä–∏ (–§–∏–∑–∏–∫–∞, 1903)", q: "”®–º—ñ—Ä–¥–µ –µ—à—Ç–µ“£–µ–¥–µ–Ω “õ–æ—Ä“õ—É–¥—ã“£ “õ–∞–∂–µ—Ç—ñ –∂–æ“õ, —Ç–µ–∫ —Ç“Ø—Å—ñ–Ω—É –∫–µ—Ä–µ–∫." },
  { a: "–ú–∞—Ä—Ç–∏–Ω –õ—é—Ç–µ—Ä –ö–∏–Ω–≥ (–ë–µ–π–±—ñ—Ç—à—ñ–ª—ñ–∫, 1964)", q: "“ö–∞—Ä–∞“£“ì—ã–ª—ã“õ—Ç—ã “õ–∞—Ä–∞“£“ì—ã–ª—ã“õ “õ—É–∞ –∞–ª–º–∞–π–¥—ã, –æ–Ω—ã —Ç–µ–∫ –∂–∞—Ä—ã“õ “õ–∞–Ω–∞ –∂–∞—Å–∞–π –∞–ª–∞–¥—ã." },
  { a: "–≠—Ä–Ω–µ—Å—Ç –•–µ–º–∏–Ω–≥—É—ç–π (”ò–¥–µ–±–∏–µ—Ç, 1954)", q: "–ê–¥–∞–º –∂–µ“£—ñ–ª—É “Ø—à—ñ–Ω –∂–∞—Ä–∞—Ç—ã–ª–º–∞“ì–∞–Ω. –ê–¥–∞–º–¥—ã “õ“±—Ä—Ç—É“ì–∞ –±–æ–ª–∞–¥—ã, –±—ñ—Ä–∞“õ –∂–µ“£—É–≥–µ –±–æ–ª–º–∞–π–¥—ã." },
  { a: "–ú–∞–ª–∞–ª–∞ –Æ—Å—É—Ñ–∑–∞–π (–ë–µ–π–±—ñ—Ç—à—ñ–ª—ñ–∫, 2014)", q: "–ë—ñ—Ä –±–∞–ª–∞, –±—ñ—Ä –º“±“ì–∞–ª—ñ–º, –±—ñ—Ä –∫—ñ—Ç–∞–ø –∂”ô–Ω–µ –±—ñ—Ä “õ–∞–ª–∞–º ”ô–ª–µ–º–¥—ñ ”©–∑–≥–µ—Ä—Ç–µ –∞–ª–∞–¥—ã." },
  { a: "–ë–∞—Ä–∞–∫ –û–±–∞–º–∞ (–ë–µ–π–±—ñ—Ç—à—ñ–ª—ñ–∫, 2009)", q: "–ë–æ–ª–∞—à–∞“õ –∫“Ø—Ç–∫–µ–Ω–¥—ñ –±—ñ–ª–µ—Ç—ñ–Ω–¥–µ—Ä–≥–µ —Å—ã–π –∂–∞—Å–∞–π–¥—ã." },
  { a: "–†–∞–±–∏–Ω–¥—Ä–∞–Ω–∞—Ç –¢–∞–≥–æ—Ä (”ò–¥–µ–±–∏–µ—Ç, 1913)", q: "–ë“±–ª—Ç—Ç–∞—Ä –º–µ–Ω—ñ“£ ”©–º—ñ—Ä—ñ–º–µ –∂–∞“£–±—ã—Ä ”ô–∫–µ–ª—É “Ø—à—ñ–Ω –µ–º–µ—Å, –±–∞—Ç“õ–∞–Ω –∫“Ø–Ω–Ω—ñ“£ –∞—Å–ø–∞–Ω—ã–Ω–∞ –±–æ—è—É “õ–æ—Å—É “Ø—à—ñ–Ω –∫–µ–ª–µ–¥—ñ." },
  { a: "–£–∏–Ω—Å—Ç–æ–Ω –ß–µ—Ä—á–∏–ª–ª—å (”ò–¥–µ–±–∏–µ—Ç, 1953)", q: "–ñ–µ—Ç—ñ—Å—Ç—ñ–∫ ‚Äì –±“±–ª —Å”ô—Ç—Å—ñ–∑–¥—ñ–∫—Ç–µ–Ω —Å”ô—Ç—Å—ñ–∑–¥—ñ–∫–∫–µ —ã–Ω—Ç–∞“£–¥—ã –∂–æ“ì–∞–ª—Ç–ø–∞–π –∂–µ—Ç—É." },
  { a: "–î–∞–ª–∞–π –õ–∞–º–∞ XIV (–ë–µ–π–±—ñ—Ç—à—ñ–ª—ñ–∫, 1989)", q: "–ë–∞“õ—ã—Ç –¥–∞–π—ã–Ω –Ω”ô—Ä—Å–µ –µ–º–µ—Å. –û–ª —Å—ñ–∑–¥—ñ“£ —ñ—Å-”ô—Ä–µ–∫–µ—Ç—Ç–µ—Ä—ñ“£—ñ–∑–¥–µ–Ω —Ç—É—ã–Ω–¥–∞–π–¥—ã." }
];

// --- LOGIC HELPERS (STRICT) ---
function getTempLogic(t) {
    if(t < -35) return { txt: "”®–¢–ï “ö–ê–£–Ü–ü–¢–Ü –ê–Ø–ó", cls: "c-danger", desc: "”®—Ç–µ —Å—É—ã“õ" };
    if(t < -20) return { txt: "–ê–Ø–ó–î–´ –ï–°–ö–ï–†–¢–£", cls: "c-warn", desc: "–°—É—ã“õ" };
    if(t < -10) return { txt: "–û–†–¢–ê–®–ê –°–£–´“ö", cls: "c-safe", desc: "–û—Ä—Ç–∞—à–∞" };
    if(t < 0)   return { txt: "–°–ê–õ“ö–´–ù–î–ê–£", cls: "c-safe", desc: "–°–∞–ª“õ—ã–Ω" };
    return { txt: "“ö–ê–õ–´–ü–¢–´", cls: "c-safe", desc: "–ñ—ã–ª—ã" };
}

function getWindLogic(w) {
    // w is in m/s
    if(w > 15)  return { txt: "–î–ê–£–´–õ–î–´", cls: "c-danger", msg: "”®–¢–ï “ö–ê–£–Ü–ü–¢–Ü!" };
    if(w > 4.5) return { txt: "–ñ–ï–õ–î–Ü", cls: "c-warn", msg: "–ï–°–ö–ï–†–¢–£" };
    return { txt: "“ö–∞–ª—ã–ø—Ç—ã", cls: "c-safe", msg: "“ö–∞–ª—ã–ø—Ç—ã" };
}

function getAQILogic(pm) {
    // WHO Standard: >15 is warning for sensitive, >45 is unhealthy
    if(pm > 45) return { txt: "“ö–ê–£–Ü–ü–¢–´", cls: "c-danger", w: "100%" };
    if(pm > 15) return { txt: "–û–†–¢–ê–®–ê", cls: "c-warn", w: "50%" };
    return { txt: "–¢–ê–ó–ê", cls: "c-safe", w: "20%" };
}

// --- INIT ---
let curLoc = LOCATIONS[0];
let mapInst=null, chartInst=null;
let refreshTimer = null;

document.addEventListener('DOMContentLoaded', () => {
  const s = document.getElementById('locSelect');
  let def = document.createElement('option');
  def.text = "–ê–π–º–∞“õ—Ç—ã —Ç–∞“£–¥–∞“£—ã–∑..."; def.disabled = true; def.selected = true;
  s.add(def);

  LOCATIONS.forEach((l,i) => {
    let o = document.createElement('option');
    o.value = i; o.text = l.name;
    s.add(o);
  });
  
  s.addEventListener('change', (e) => {
    curLoc = LOCATIONS[e.target.value];
    document.getElementById('locName').innerText = curLoc.name;
    smartFetch();
  });

  // Random Nobel
  const rq = NOBEL_QUOTES[Math.floor(Math.random()*NOBEL_QUOTES.length)];
  document.getElementById('qText').innerText = `"${rq.q}"`;
  document.getElementById('qAuth').innerText = rq.a;

  setInterval(updateClock, 1000);
  updateClock();
  initParticles();
  smartFetch();
  
  // Auto Refresh every 15 minutes (900,000 ms)
  setInterval(smartFetch, 900000);
});

function updateClock() {
  const now = new Date();
  document.getElementById('clockDisplay').innerText = now.toLocaleTimeString('kk-KZ', {hour12:false});
}

// --- DATA ENGINE ---
async function smartFetch() {
  const b = document.getElementById('sourceBadge');
  b.style.background="rgba(255,255,255,0.1)"; b.innerText="–ñ–ê“¢–ê–†–¢–´–õ–£–î–ê...";
  
  const p = `latitude=${curLoc.lat}&longitude=${curLoc.lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,snow_depth&hourly=temperature_2m,weather_code,wind_speed_10m,precipitation,relative_humidity_2m&daily=weather_code,temperature_2m_max,temperature_2m_min,wind_speed_10m_max,precipitation_sum,sunrise,sunset&timezone=auto&models=ecmwf_ifs025`;
  const aqP = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${curLoc.lat}&longitude=${curLoc.lon}&current=pm2_5`;

  try {
    const [wRes, aRes] = await Promise.all([
      fetch(`https://api.open-meteo.com/v1/forecast?${p}`),
      fetch(aqP)
    ]);
    const w = await wRes.json();
    const a = await aRes.json();

    const time = new Date().toLocaleTimeString('kk-KZ', {hour:'2-digit', minute:'2-digit'});
    b.innerText = `ECMWF PRO ‚Ä¢ ${time}`;
    b.style.borderColor = "var(--safe)";
    render(w, a);
  } catch(e) {
    b.innerText = "OFFLINE";
    b.style.borderColor = "var(--danger)";
  }
}

// --- RENDER ---
function render(w, a) {
  const c = w.current;
  const h = w.hourly;
  const d = w.daily;
  const pm = a.current ? a.current.pm2_5 : 0;

  // HERO
  const temp = Math.round(c.temperature_2m);
  const wind = (c.wind_speed_10m / 3.6); // km/h to m/s
  const tLogic = getTempLogic(temp);
  
  document.getElementById('curTemp').innerText = temp + "¬∞";
  document.getElementById('curDesc').innerText = tLogic.desc;
  document.getElementById('wittyText').innerText = tLogic.txt;
  
  // WIND
  const wEl = document.getElementById('val-wind');
  const wBox = document.getElementById('box-wind');
  const wSub = document.getElementById('sub-wind');
  const wLog = getWindLogic(wind);
  
  wEl.innerText = wind.toFixed(1);
  wSub.innerText = wLog.msg;
  wBox.className = `stat-box ${wLog.cls}`;

  // HUMIDITY
  document.getElementById('val-hum').innerText = c.relative_humidity_2m + "%";

  // AQI (WHO)
  const aqVal = document.getElementById('val-aqi');
  const aqSub = document.getElementById('sub-aqi');
  const aqBar = document.getElementById('aqi-fill');
  const aqBox = document.getElementById('box-aqi');
  const aqLog = getAQILogic(pm);

  aqVal.innerText = Math.round(pm);
  aqSub.innerText = aqLog.txt;
  aqBar.style.width = aqLog.w;
  aqBar.style.background = `var(--${aqLog.cls.replace('c-','')})`;
  aqBox.className = `stat-box ${aqLog.cls}`;

  // SNOW
  const snow = c.snow_depth || 0;
  const sBox = document.getElementById('box-snow');
  const sSub = document.getElementById('sub-snow');
  document.getElementById('val-snow').innerText = snow + " —Å–º";
  if(snow > 20) { sBox.className="stat-box c-danger"; sSub.innerText="–ñ–û–õ –ñ–ê–ë–´“ö!"; }
  else if(snow > 5) { sBox.className="stat-box c-warn"; sSub.innerText="“ö–ê–õ–´“¢"; }
  else { sBox.className="stat-box c-safe"; sSub.innerText="“ö–∞–ª—ã–ø—Ç—ã"; }

  // CHART
  drawChart(h.time, h.temperature_2m);
  
  // SUN
  if(d.sunrise && d.sunset) {
    drawSunPath(d.sunrise[0], d.sunset[0]);
    document.getElementById('sunriseTime').innerText = d.sunrise[0].slice(11,16);
    document.getElementById('sunsetTime').innerText = d.sunset[0].slice(11,16);
  }

  // 24H LIST (Logic Applied)
  let hHTML = "";
  const nowH = new Date().getHours();
  for(let i=nowH; i<nowH+24; i++) {
    if(!h.time[i]) break;
    const t = h.time[i].slice(11,16);
    const tmp = Math.round(h.temperature_2m[i]);
    const wSpd = (h.wind_speed_10m[i]/3.6).toFixed(1);
    const prec = h.precipitation[i];
    
    // Logic colors for Hourly
    let wCls = "color:var(--safe)";
    if(wSpd > 15) wCls = "color:var(--danger)";
    else if(wSpd > 4.5) wCls = "color:var(--warn)";

    let tCls = "";
    if(tmp < -35) tCls = "color:var(--danger)";
    else if(tmp < -20) tCls = "color:var(--warn)";

    hHTML += `
      <div class="h-card">
        <div style="font-size:11px;opacity:0.8">${t}</div>
        <div style="font-size:20px">${getIcon(h.weather_code[i])}</div>
        <div style="font-weight:700;${tCls}">${tmp}¬∞</div>
        <div style="font-size:10px;${wCls}"><i class="fas fa-wind"></i> ${wSpd}</div>
        <div style="font-size:9px;opacity:0.7">üíß ${prec}–º–º</div>
      </div>
    `;
  }
  document.getElementById('hourlyList').innerHTML = hHTML;

  // 7 DAY LIST (Strict Logic: Day/Night, Wind, Rain)
  let dHTML = "";
  for(let i=0; i<7; i++) {
    const dt = new Date(d.time[i]);
    const dayName = dt.toLocaleDateString('kk-KZ', {weekday:'long'}); 
    const max = Math.round(d.temperature_2m_max[i]);
    const min = Math.round(d.temperature_2m_min[i]);
    const wMax = (d.wind_speed_10m_max[i]/3.6).toFixed(1);
    const rain = d.precipitation_sum[i];

    // Temp Warning Logic
    let minCls = "opacity:0.7";
    if(min < -35) minCls="color:var(--danger);font-weight:800";
    else if(min < -20) minCls="color:var(--warn);font-weight:700";

    // Wind Warning Logic
    let wMsg = "“ö–∞–ª—ã–ø—Ç—ã"; let wStyle = "color:var(--safe)";
    if(wMax > 15) { wStyle="color:var(--danger);font-weight:700"; wMsg="–î–ê–£–´–õ!"; }
    else if(wMax > 4.5) { wStyle="color:var(--warn);font-weight:700"; wMsg="–ñ–µ–ª–¥—ñ"; }

    dHTML += `
      <div class="d-row">
        <div class="d-top">
          <div style="text-transform:capitalize">${dayName}</div>
          <div style="display:flex;gap:8px">
            <span>${getIcon(d.weather_code[i])}</span>
            <span>–ö“Ø–Ω–¥—ñ–∑: ${max}¬∞</span>
          </div>
        </div>
        <div class="d-bot">
          <div class="d-detail" style="${wStyle}">üí® ${wMax} –º/—Å ‚Ä¢ ${wMsg}</div>
          <div class="d-detail">–¢“Ø–Ω–¥–µ: <span style="${minCls}">${min}¬∞</span></div>
          <div class="d-detail">–ñ–∞—É—ã–Ω: ${rain} –º–º</div>
        </div>
      </div>
    `;
  }
  document.getElementById('dailyList').innerHTML = dHTML;

  updateBg(c.weather_code);
  initMap(w.latitude, w.longitude);
}

// --- VISUALS ---
function getDesc(c) {
  const m = {0:"–ê—à—ã“õ",1:"–ë“±–ª—Ç—Ç—ã",2:"–ë“±–ª—Ç—Ç—ã",3:"–¢“±—Ç–∞—Å –±“±–ª—Ç",45:"–¢“±–º–∞–Ω",51:"–ñ–∞“£–±—ã—Ä",71:"“ö–∞—Ä",95:"–ù–∞–π–∑–∞“ì–∞–π"};
  return m[c] || "–ñ–∞—É—ã–Ω-—à–∞—à—ã–Ω";
}
function getIcon(c) {
  if(c==0) return "‚òÄÔ∏è"; if(c<3) return "‚õÖ"; if(c<50) return "‚òÅÔ∏è"; if(c<60) return "üåß"; if(c<80) return "‚ùÑÔ∏è"; return "‚õà";
}

function drawSunPath(riseStr, setStr) {
  const cvs = document.getElementById('sunCanvas');
  const ctx = cvs.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = cvs.getBoundingClientRect();
  cvs.width = rect.width * dpr; cvs.height = rect.height * dpr;
  ctx.scale(dpr, dpr);
  const w = rect.width; const h = rect.height;
  
  const now = new Date(); const rise = new Date(riseStr); const set = new Date(setStr);
  const total = (set-rise)/60000; const curr = (now-rise)/60000;
  let pct = curr/total; if(pct<0) pct=0; if(pct>1) pct=1;
  const isNight = (now < rise || now > set);

  ctx.clearRect(0,0,w,h);
  ctx.beginPath(); ctx.strokeStyle="rgba(255,255,255,0.2)"; ctx.lineWidth=1;
  ctx.moveTo(0,h-15); ctx.lineTo(w,h-15); ctx.stroke();
  
  const pad=20; const aw=w-(pad*2);
  ctx.beginPath(); ctx.strokeStyle="rgba(255,255,255,0.1)"; ctx.setLineDash([5,5]); ctx.lineWidth=2;
  for(let i=0; i<=aw; i++){
    const x=pad+i; const nx=(i/aw)*Math.PI; const y=(h-15)-Math.sin(nx)*(h-30);
    if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  if(!isNight){
    ctx.beginPath(); ctx.setLineDash([]); ctx.strokeStyle="#f39c12"; ctx.lineWidth=3;
    const stop=pct*aw;
    for(let i=0; i<=stop; i++){
      const x=pad+i; const nx=(i/aw)*Math.PI; const y=(h-15)-Math.sin(nx)*(h-30);
      if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
    const sx=pad+(pct*aw); const snx=(pct*Math.PI); const sy=(h-15)-Math.sin(snx)*(h-30);
    ctx.shadowBlur=15; ctx.shadowColor="#f39c12"; ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(sx,sy,6,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle="rgba(243,156,18,0.5)"; ctx.lineWidth=1; ctx.beginPath(); ctx.arc(sx,sy,10,0,Math.PI*2); ctx.stroke(); ctx.shadowBlur=0;
  }
}

function drawChart(times, temps) {
  const ctx = document.getElementById('mainChart').getContext('2d');
  const now = new Date().getHours();
  if(chartInst) chartInst.destroy();
  const grad = ctx.createLinearGradient(0,0,0,200);
  grad.addColorStop(0, 'rgba(41, 128, 185, 0.5)');
  grad.addColorStop(1, 'rgba(41, 128, 185, 0)');

  chartInst = new Chart(ctx, {
    type: 'line',
    data: {
      labels: times.slice(now, now+24).map(t=>t.slice(11,16)),
      datasets: [{
        data: temps.slice(now, now+24),
        borderColor: '#2980b9', borderWidth: 3, backgroundColor: grad, fill: true, tension: 0.4, pointRadius: 0
      }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend:false }, scales: { x:{display:false}, y:{display:false} } }
  });
}

function initMap(lat, lon) {
  if(mapInst) { mapInst.setView([lat, lon], 7); return; }
  mapInst = L.map('map', {zoomControl:false}).setView([lat, lon], 7);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(mapInst);
  const ts = Math.floor(Date.now()/1000) - 900;
  L.tileLayer(`https://tile.cache.rainviewer.com/v2/radar/${ts}/256/{z}/{x}/{y}/2/1_1.png`, {opacity:0.7}).addTo(mapInst);
  L.circleMarker([lat, lon], {radius:6, color:'#2980b9', fillOpacity:1}).addTo(mapInst);
}

const cvs = document.getElementById('bg-canvas');
const cx = cvs.getContext('2d');
let parts = [];
function initParticles(){ cvs.width=window.innerWidth; cvs.height=window.innerHeight; animate(); }
function updateBg(c) {
  const gr = document.getElementById('gradient-overlay');
  parts = [];
  if(c>=71) { gr.style.background="radial-gradient(circle at 50% 0%, #34495e 0%, #1c2833 100%)"; mkParts('s'); }
  else if(c>=51) { gr.style.background="radial-gradient(circle at 50% 0%, #424949 0%, #17202a 100%)"; mkParts('r'); }
  else if(c<=1) { gr.style.background="radial-gradient(circle at 50% -20%, #d35400 0%, #1a1a2e 70%)"; }
  else { gr.style.background="radial-gradient(circle at 50% 0%, #2c3e50 0%, #000 80%)"; }
}
function mkParts(t) {
  for(let i=0; i<60; i++) parts.push({x:Math.random()*cvs.width, y:Math.random()*cvs.height, s:Math.random()*2+2, t:t});
}
function animate() {
  cx.clearRect(0,0,cvs.width,cvs.height);
  cx.fillStyle="rgba(255,255,255,0.5)";
  parts.forEach(p=>{
    cx.beginPath();
    if(p.t=='s') cx.arc(p.x,p.y,p.s/2,0,Math.PI*2); else cx.fillRect(p.x,p.y,1,p.s*2);
    cx.fill(); p.y+=p.s; if(p.y>cvs.height) p.y=0;
  });
  requestAnimationFrame(animate);
}
</script>
</body>
</html>
